<!DOCTYPE html>
<meta charset="utf-8">
<body style="background-color:grey;">
<div class="content">
<script src="d3.v3.min.js"></script>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
  <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
  <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script>
  <script src="jquery.parse.min.js"></script>

<script>

function getFile(id) {
dates = [1789030, 1789080, 1790040, 1790050, 1791030, 1791090, 1792030, 1792060, 1794010, 1795100, 1796060, 1798040, 1800070, 1800071, 1800100, 1802040, 1803030, 1803040, 1804030, 1804100, 1805010, 1805070, 1809030, 1810040, 1810100, 1812040, 1812050, 1812060, 1813040, 1816120, 1817030, 1817120, 1818100, 1818120, 1819030, 1819120, 1820030, 1821070, 1821080, 1821090, 1821091, 1822030, 1824110, 1825010, 1828050, 1834060, 1836030, 1836060, 1836070, 1837010, 1837030, 1838070, 1842110, 1845030, 1845120, 1846060, 1846080, 1846120, 1847010, 1847030, 1848020, 1848050, 1848080, 1849030, 1850090, 1853030, 1853120, 1854050, 1858050, 1859020, 1860020, 1860120, 1861010, 1861011, 1861012, 1861013, 1861014, 1861015, 1861020, 1861021, 1861022, 1861030, 1861031, 1861040, 1861041, 1861050, 1861051, 1861052, 1861053, 1861054, 1861070, 1861080, 1861100, 1861110, 1861120, 1861121, 1862070, 1863020, 1863030, 1863060, 1864050, 1864100, 1865040, 1866050, 1866070, 1867010, 1867030, 1867100, 1868060, 1868061, 1868070, 1868071, 1868072, 1868073, 1870010, 1870020, 1870030, 1870070, 1872100, 1876080, 1882030, 1884050, 1889110, 1889111, 1889112, 1890050, 1890070, 1890071, 1894070, 1896010, 1896050, 1898080, 1900060, 1903100, 1907110, 1912010, 1912020, 1912080, 1921030, 1959010, 1959080];
var closest = null;

$.each(dates, function(){
  if (this <= id && (closest == null || (id - this) < (id - closest))) {
    closest = this;
  }
});
return closest;

}
var maps = {};
var test = '';
$(document).ready(function() {
function logConsole(){
  $.each($('.state'), function(index, value){
    $('#console').append($(value).attr("state") + " : " + $(value).attr("executions") + "; ")
  });
}

var color = d3.scale.linear()
    .domain([0, 0.001, 0.003, 0.007, 0.009, 0.15, 0.5, 0.7])
    .range(["rgb(247,251,255)", "rgb(222,235,247)", "rgb(198,219,239)", "rgb(158,202,225)", "rgb(107,174,214)", "rgb(66,146,198)", "rgb(33,113,181)", "rgb(8,81,156)", "rgb(8,48,137)"]);
function triggerRedraw(id){
    id.sort(function(a,b){return a-b});
    $("#currentYear").html("<h1>" + id[0].toString().substring(0,4) + " - " + id[1].toString().substring(0,4) + "</h1>");
    mapfile = getFile(id[1]);
    ready(maps, mapfile)
    getExecutions(parseInt(id[0].toString().substring(0,4)),parseInt(id[1].toString().substring(0,4)))
}

function updateMap(id){
    id.sort(function(a,b){return a-b});
    $("#currentYear").html("<h1>" + id[0].toString().substring(0,4) + " - " + id[1].toString().substring(0,4) + "</h1>");
    mapfile = getFile(id[1]);
    changemap(maps, mapfile)
    getExecutions(parseInt(id[0].toString().substring(0,4)),parseInt(id[1].toString().substring(0,4)))
}
$( "#slider" ).slider({
  change: function( event, ui ) {
    updateMap(ui.values)
  },
  range: "max",
    min: 1789030, // min value
    max: 2002080, // max value
    values: [1789030, 2002080]
});
var width = 900,
    height = 500;

var svg = d3.select(".content").append("svg")
    .attr("id", "map")
    .attr("width", width)
    .attr("height", height)
    .attr("style", "float:left;");
function DrawChloropleth(totalExecutions) {
var color = d3.scale.linear()
    .domain([0, 0.001, 0.003, 0.007, 0.009, 0.15, 0.5, 0.7])
    .range(["rgb(247,251,255)", "rgb(222,235,247)", "rgb(198,219,239)", "rgb(158,202,225)", "rgb(107,174,214)", "rgb(66,146,198)", "rgb(33,113,181)", "rgb(8,81,156)", "rgb(8,48,137)"]);
  $.each($('.state'), function(index,value){
      executions = parseInt($(value).attr("executions"))
          gradient = (executions/totalExecutions)
          $(value).attr("fill", color(gradient))
  });

}
function getExecutions(begin,end) {
  $.ajax({
    url: "data.csv",
    success: function (csvd) {
        results = $.parse(csvd, {
          delimiter: ",",
          header: true,
          dynamicTyping: true
      })
    totalExecutions = 0;
    $.each(results.results.rows, function(index,value){
      if(value.DateYear >= begin && value.DateYear <= end){
        state = $('path[state="' + value.StateOfExecution + '"]')
        if(state) {
          executions = parseInt(state.attr("executions"))
          state.attr("executions", ++executions);
          totalExecutions = ++totalExecutions;
        }
      }
    })
    DrawChloropleth(totalExecutions)
    logConsole()
    }
});
}
var projection = d3.geo.albersUsa().scale(800);
var path = d3.geo.path().projection(projection);
var width = 900,
    height = 500;
d3.json("GeoJSON/master.topojson", function(error, data) {window.maps = data})
function ready(maps) {
 myMap = svg.selectAll("path");
 myMap.data(topojson.feature(maps, maps.objects[1789030]).features)
 .enter().append("path")
 .attr("d", path)
 .attr("class", function(d){
                    return d.properties.CATEGORY;
                  })
 .attr("state", function(d){
                  return d.properties.LABEL;
              })
 .attr("executions", 0)
 .style("stroke", "#ffffff");
}

function changemap(maps, mapfile) {
myMap = svg.selectAll("path")
.data(topojson.feature(maps, maps.objects[mapfile]).features);
 myMap.enter().append("path")
 myMap.attr("d", path)
  .attr("class", function(d){
                    return d.properties.CATEGORY;
                  })
 .attr("state", function(d){
                  return d.properties.LABEL;
              })
 .attr("executions", 0)
 .style("stroke", "#ffffff");
 myMap.exit().remove();
 }
//Setup the initial render
d3.json("GeoJSON/master.topojson", function(error, data) {
  window.maps = data;
  triggerRedraw([1789030,200280])
})

});
</script>
<div id="slider" style="width:960px; margin-left:10px;"></div>
<div id="currentYear" style="width:100px; margin-left:auto; margin-right:auto;"><h1>1789</h1></div>
<div id="console" style="width:400px; display:none; float:left;"></div>
<style>
.state {
}
.seceded_state,
.other_country,
.disputed,
.none,
.territory {
  fill: beige;
}
.content {
	width:800px; margin:0 auto;
}
</style>
</div>
</body>
</html>